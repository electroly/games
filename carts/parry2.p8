pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
--parry 2: parry vs. uncle matt
--by electroly

function _init()
 --last btn state, for edge trig
 lstbtn={}
 btnup={}
 btndn={}
 for i=0,5 do
 	lstbtn[i]=false
 	btnup[i]={}
 	btndn[i]={}
 end
 
	--scenes
	scn={}
	scn.title=0
	scn.intro=1
	
	init_font1()
	change_scene(scn.title)
end

function _update60()
	ctr+=1
	
	--button edge triggering
	for i=0,5 do
	 local lst=lstbtn[i]
		local now=btn(i)
		btnup[i]=lst and not now
		btndn[i]=now and not lst
		lstbtn[i]=now
	end
	
	if scene==scn.title then
		update_title_scene()
	elseif scene==scn.intro then
		update_intro_scene()
	end
end

function _draw()
	if(scene==scn.title)draw_title_scene()
	if(scene==scn.intro)draw_intro_scene()
end

---font1
function init_font1()
	font1={}
	font1.charmap={} --x,y,w,h
	local h=5
	
	local lettersx={0,4,8,12,16,20,24,28,32,35,39,43,46,51,55,59,63,67,71,75,79,83,88,93,97,100,103}
	local lettersy=48
	local letters="abcdefghijklmnopqrstuvwxyz"
	for i=1,#letters do
		local ch=sub(letters,i,i)
		local charmap={}
		charmap.x=lettersx[i]
	 charmap.y=lettersy
		charmap.w=lettersx[i+1]-charmap.x
		charmap.h=h
		font1.charmap[ch]=charmap
	end
	
	local numbersx={0,3,6,9,12,15,18,21,24,27,30,38,46,53,60,67,74,75,77,79,81,83,84,85,89}
	local numbersy=53
	local numbers="0123456789‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è‚ùéüÖæÔ∏è., ():!?"
	for i=1,#numbers do
		local ch=sub(numbers,i,i)
		local charmap={}
		charmap.x=numbersx[i]
		charmap.y=numbersy
		charmap.w=numbersx[i+1]-charmap.x
		charmap.h=h
		font1.charmap[ch]=charmap
	end
end

function print_font1(t,x,y)
	for i=1,#t do
		local ch=sub(t,i,i)
		local rct=font1.charmap[ch]
		if rct!=nil then
			sspr(rct.x,rct.y,rct.w,rct.h,x,y)
			x+=rct.w+1
		end
	end
end

function font1_width(t)
	local x=0
	for i=1,#t do
		local ch=sub(t,i,i)
		local rct=font1.charmap[ch]
		if rct!=nil then
			x+=rct.w+1
		end
	end
	return x
end
---end font1

function change_scene(n)
	scene=n
	scst={} --scene state
	ctr=0
	music(-1)
	if(n==scn.title)music(0)
end

function draw_title_scene()
	cls(1)
	sspr(0,32,32,16,centerx(32),30)
	local t="the quest for uncle matt"
	print_wavy(t,center_text(t),55,14)
	t="press ‚ùé to play"
	print_font1(t,centerx(font1_width(t)),80)
	t="pc keys: ‚ùéx üÖæÔ∏èc"
	print_font1(t,centerx(font1_width(t)),110)
	t="(c) 2022 brian luft"
	print_font1(t,centerx(font1_width(t)),120)
end

function update_title_scene()
	if(btndn[5])change_scene(scn.intro)
end

function map_flip_waves()
	for x=0,16 do
		for y=0,16 do
			local s=mget(x,y)
			if s==41 then
				s=23
			elseif s==23 then
				s=41
			end
			mset(x,y,s)
		end
	end
end

function draw_map()
	if((ctr%60)==0)map_flip_waves()
	map(0,0,0,0,16,16)
end

function update_intro_scene()
 if(ctr==30)sfx(0,0)
	if ctr>30 then
		if(btndn[5])change_scene(scn.title)
	end
end

function draw_intro_scene()
	cls(0)
	draw_map()
	if(ctr>=30)draw_dlg({"this is parrot island.","","uncle matt is held","hostage at the castle!","","are you a bad enough","bird to rescue uncle","matt?","","  ‚ùé continue"},20)
end

function draw_dlg(ts,y)
	local maxw=0
	for _,t in pairs(ts) do
		maxw=max(font1_width(t),maxw)
	end	
	local x=centerx(maxw+16)
	draw_dlg_box(x,y,maxw+16,16+#ts*6)
	y+=8
	for _,t in pairs(ts) do
		print_font1(t,x+8,y,7)
		y+=6
	end
end

function draw_dlg_box(x,y,w,h)
	--background
	rectfill(x+1,y+1,x+w-2,y+h-2,13)
	--top line
	line(x+2,y,x+w-3,y,7)
	--left line
	line(x,y+2,x,y+h-3,7)
	--right line
	line(x+w-1,y+2,x+w-1,y+h-3,1)
	--bottom line
	line(x+2,y+h-1,x+w-3,y+h-1,1)
	--upper left
	spr(68,x,y)
	--upper right
	spr(69,x+w-8,y)
	--lower left
	spr(84,x,y+h-8)
	--lower right
	spr(85,x+w-8,y+h-8)
end

function print_wavy(t,x,y,c)
	local clock=-2*3.14159*ctr/400
	for i=1,#t do
		local ch=sub(t,i,i)
		local yoff=2*cos(clock+0.075*i)
		print(ch,x+(i-1)*4,y+yoff,c)
	end
end

function centerx(w)
	return 64-w/2
end

function center_text(t)
	return 64-#t*2
end

__gfx__
00000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111566111111111115665111333333333333333333333333333113331111111133b3343333333b33338333333333383333336533333333333333653333336533
11663361166661116633661133333333333333333a33333333331133111111113bbb33b333a3bbb3388e333a33338e8333337533333333333333753333337533
163333366333365633333361333a333333333a333333333333311333cc1111113bbb3bbb3333bbb3e8e883333338e88e33336533337777333333653333336533
5633a33333333363333e33653333333333333333333311313113133311cc11cc33433bbb33333433366733333333766333337533117777513333753333337533
6333333333a3333333a3333633333e33333333333331311313113333111111113b333343333b3333360633333333606333336533137777537676533367676533
63333333333333a3333333363333333333333333333113333333333311111111bbb33b3333bbb333367636366363676333337533317777535555753355555333
163333333333333333333365333333333a33333333113333333333a3c11cc11cbbb3bbb333bbb333360656676665606333336533333555533333653333333333
16333333a33333333a3333613333333333333333333113333e3333331cc11c113433bbb333343333376656666765667333337533333333333333753333333333
116333333e33a3333333361133333333333333333333333333333611333133333333333311111111360757066065606333333333333133333333653333533333
1163333333333333333365113333a33333333333333a3333333361113333133a33333b3311111111366656666665766333333333333313333333753335553633
11633a33333333a333a336113333333333e333333333333331111116333113333333bbb311cc1111367656076065666333333333337777333333653355056563
163333333a3333333333336133333333333333331133113111111611333133333b33bbb3cc11cc11366656666665676333333333337777533333753305566666
6333333333333a33a333333633333333333a333313113113a33311113a331333bbb334331111111136a7567666656a7367673333337777537676567655676656
16633333333a3333333333363333333333333333311333333333331133331133bbb3333311111111379656644675696355557533337777535555355560777505
11563333333333e33333a3613333333333333333333333333333a3613331313334333a331cc11cc1364656644565646333336533333555533333333307767750
116333a3333333333333365133333333333333e333333333333336513331133333333333111cc11c366756644665666333337533333113333333333376777670
1163333333333333a333336133333611116333333333333333333333333a13331111111133333333336666333333333333333333333365333333333300000000
163333333a333333333333653a3361111116333333333a333333a333333311331661111133333333363335333333333333333333333375333333333300000000
633333a333333a333333a3363336111111116333333333333333333333331133633661663333a333363aaaaa3377773333333333333365333333333300000000
63a33e3333333333333333363336511665163a333663333333333663333311633333363333333333363959593377775333333333333375333333333300000000
633333333633333333333336333361633663333365163333333361563a3611133333333333633333363959593377775376767676333337673333367600000000
163333336563366363333361333336333333333361116333a336511163311116333a333366166336363959593377775355555555333335553333755500000000
16363366111665165633361133a3333e333333331115633333336111163111113333333311111661363959593335555333333333333333333333653300000000
116566111111111111666111333333333a3333331116333333333611116116113333333311111111363aaaaa3333333333333333333333333333753300000000
00777777775000000000000000000000007777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000
0777777777770000000000000000000007dddddddddddd7000000000000000000000000000000000000000000000000000000000000000000000000000000000
750770000777700000000000000000007ddd777dddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000077700000000000000000007dd7ddddddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000077700000000000000000007d7dddddddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000077700000000000000000007d7dddddddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
000777777777000000000000000000007d7dddddddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
0007777777700000000000000000000e7dddddddddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
00077700000000000000000000eeeee27dddddddddddddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
0007750077007700770070700e2e0e007dddddddddddd1d100000000000000000000000000000000000000000000000000000000000000000000000000000000
005770070070707070707070000e0e007dddddddddddd1d100000000000000000000000000000000000000000000000000000000000000000000000000000000
007770077770770077007070000e0e007dddddddddddd1d100000000000000000000000000000000000000000000000000000000000000000000000000000000
057770070070707070705770000e0e007ddddddddddd1dd100000000000000000000000000000000000000000000000000000000000000000000000000000000
077770770770707070700070000e0eee7dddddddd111ddd100000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007007000eeeee207dddddddddddd1000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000077500ee20000001111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000
07707770077077777770777707777007777777770070707707770070770777007707770077777777007700077000770077077770000000000000000000000000
70077007700770077000700770007007070007070707007070777077007700770077007700007007007700077000707077070070000000000000000000000000
77077770700070077770770070777777070007077007007070770777007770770077707777007007007070707070707700770700000000000000000000000000
70777007700070077000700070077007070707070707007000770077007707070707070000707007007070707070770700077000000000000000000000000000
70077770077777707777700007707007777077070077777000770070770700007077007777000700770007000707070077707770000000000000000000000000
7770707707707077770777777777770ee2eee00eee2ee00ee2ee00ee2ee00eeeee00eeeee0000000770070770000000000000000000000000000000000000000
707770007007707700700007707707ee22eeeeeeee22eeee222eeeee2eeeee2e2eeee222ee000007007777007000000000000000000000000000000000000000
707070070070777770770007777077e222222ee222222ee22222ee22222eeee2eeeee2e2ee000007007070070000000000000000000000000000000000000000
707070700007007007707070707007ee22eeeeeeee22eeeee2eeeee222eeee2e2eeee222ee007007007700000000000000000000000000000000000000000000
0777777777700077700707007777700ee2eee00eee2ee00ee2ee00ee2ee00eeeee00eeeee0770000770070070000000000000000000000000000000000000000
__map__
2929292929292929292929292929292900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1710381112171710113811113811121700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29203a2133381134212824142436322900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17203b3c3b3c3c3c3c3c2c192122171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
292023281c14181819231c143632292900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
172021211c19181815251d252617171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
293039351c15252516241c133338122900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
171717203d2d3c3c3c3c2e3c3b13221700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
292929303137352f2f2f2f2f1c28222900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
171717171717203e3c3c3c3c1e36321700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
292929292929201c363135211c22292900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
171710113811343b221720193b22171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2929201a1b14191c222930313932292900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1717202a2b3b3c1f221717171717171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2929303931393931322929292929292900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1717171717171717171717171717171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000400001a0101a0301a0301a03021030210302101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
491e00002b05028050186002b05028050000002b0500000026050260502605026050000000000000000000002b05028050000002b05028050000002b050000002d0502d0502d0502d0502b0502b0500000000000
000100002b05028050186002b05028050000002b0500000026050260502605026050000000000000000000002b05028050000002b05028050000002b050000002d0502d0502d0502d0502b0502b0500000000000
010f00201a653000033b603000031a62300003000030000321653000033b62300003216230000300003000031a653000033b603000031a623000030000300003216533b6233b6233b62321623000030000300003
011e00002b05028050186002b05028050000002b0500000026050260502605028050240502400000000000002b05028050000002b05028050000002f05024603300503005030050300502b0002b0000000000000
__music__
00 01034344
00 04034344
04 41424344

